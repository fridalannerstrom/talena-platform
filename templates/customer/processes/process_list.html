{% extends "customer/core/layouts/customer_base.html" %}
{% block content %}
{% load dict_extras %}
<div class="container-fluid px-2 px-md-3">

  <!-- Header -->
  <div class="d-flex align-items-start justify-content-between mb-4">
    <div>
      <h1 class="h4 mb-1">Testprocesser</h1>
      <div class="text-muted">Översikt över dina testprocesser och status.</div>
    </div>
    <a class="btn btn-primary" href="{% url 'processes:process_create' %}">
      Skapa testprocess
    </a>
  </div>

  <!-- Controls -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-6 col-lg-5">
          <div class="input-group">
            <span class="input-group-text bg-white">
              <i data-feather="search" style="width:16px;height:16px;"></i>
            </span>
            <input id="processSearch" type="text" class="form-control" placeholder="Sök på titel eller testpaket...">
          </div>
        </div>

        <div class="col-12 col-md-6 col-lg-4">
          <select id="packageFilter" class="form-select">
            <option value="">Alla testpaket</option>
            {# Vi bygger options via JS för att slippa backend-ändringar #}
          </select>
        </div>

        <div class="col-12 col-lg-3">
          <select id="sortBy" class="form-select">
            <option value="created_desc">Sortera: Nyast först</option>
            <option value="created_asc">Sortera: Äldst först</option>
            <option value="candidates_desc">Sortera: Flest kandidater</option>
            <option value="candidates_asc">Sortera: Färst kandidater</option>
            <option value="title_asc">Sortera: Titel A–Ö</option>
            <option value="title_desc">Sortera: Titel Ö–A</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  {% if processes %}
  <div id="processGrid" class="process-grid">
    {% for p in processes %}
    <div class="process-card card" role="button" tabindex="0" data-href="{% url 'processes:process_detail' p.id %}"
      data-title="{{ p.name|default:''|lower }}" data-package="{{ p.project_name_snapshot|default:'' }}"
      data-package-lower="{{ p.project_name_snapshot|default:''|lower }}"
      data-labels-lower="{% for lab in p.labels.all %}{{ lab.name|lower }} {% endfor %}"
      data-candidates="{{ p.candidates_count|default:0 }}" data-created="{{ p.created_at|date:'Y-m-d' }}">

      <div class="card-body process-card-body">

  <!-- Top: user labels + actions -->
  <div class="d-flex align-items-start justify-content-between gap-3">

    <!-- User-defined labels -->
<div class="d-flex align-items-center gap-2 flex-wrap mt-1">
  {% if p.labels.exists %}
    {% for lab in p.labels.all %}
      <span class="process-label">{{ lab.name }}</span>
    {% endfor %}
  {% else %}
    <span class="process-label process-label-muted">Ej kategoriserad</span>
  {% endif %}
</div>

    <!-- Actions -->
    <div class="card-actions d-inline-flex gap-1 align-items-center flex-shrink-0">
      <a class="icon-btn"
         href="{% url 'processes:process_update' p.id %}"
         aria-label="Redigera"
         onclick="event.stopPropagation();">
        <i data-feather="edit"></i>
      </a>

      <form method="post"
            action="{% url 'processes:process_delete' p.id %}"
            class="d-inline"
            onsubmit="event.stopPropagation(); return confirm('Är du säker på att du vill ta bort denna process?');">
        {% csrf_token %}
        <button type="submit" class="icon-btn" aria-label="Ta bort">
          <i data-feather="trash-2"></i>
        </button>
      </form>
    </div>
  </div>

  <!-- Title -->
  <div class="mt-3">
    <div class="process-title mb-2">
      {{ p.name }}
    </div>

    <div class="text-muted small">
      {{ p.project_name_snapshot }}
      <br>

      {% with key=p.account_code|add:"::"|add:p.project_code %}
        {% with m=meta_by_key|get_item:key %}
          {% if m and m.tests %}
            Innehåller tester:
            {% for t in m.tests|split_tests %}
              {{ t }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          {% endif %}
        {% endwith %}
      {% endwith %}
    </div>
  </div>

  <!-- Divider -->
  <div class="card-divider"></div>

  <!-- Footer meta -->
  <div class="card-footer-meta">
    <div class="meta-item">
      <i data-feather="users" class="icon-16"></i>
      <span>Kandidater: <strong>{{ p.candidates_count|default:0 }}</strong></span>
    </div>

    <div class="meta-item">
      <i data-feather="calendar" class="icon-16"></i>
      <span>Skapad: <strong>{{ p.created_at|date:"Y-m-d" }}</strong></span>
    </div>
  </div>

</div>

    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="card">
    <div class="card-body p-5 text-center">
      <div class="text-muted mb-2">Du har inga testprocesser ännu.</div>
      <a class="btn btn-dark rounded-pill px-4" href="{% url 'processes:process_create' %}">
        Skapa din första testprocess
      </a>
    </div>
  </div>
  {% endif %}

</div>

<script>
  (function () {
    const grid = document.getElementById("processGrid");
    if (!grid) return;

    const cards = Array.from(grid.querySelectorAll(".process-card"));
    const searchInput = document.getElementById("processSearch");
    const filterSelect = document.getElementById("packageFilter");
    const sortSelect = document.getElementById("sortBy");

    // Populate filter options from existing cards (unique package names)
    const packages = new Map();
    cards.forEach(c => {
      const label = (c.dataset.package || "").trim();
      if (label) packages.set(label.toLowerCase(), label);
    });
    Array.from(packages.values())
      .sort((a, b) => a.localeCompare(b))
      .forEach(label => {
        const opt = document.createElement("option");
        opt.value = label.toLowerCase();
        opt.textContent = label;
        filterSelect.appendChild(opt);
      });

    function matches(card, q, packageValue) {
      const title = card.dataset.title || "";
      const pkg = card.dataset.packageLower || "";
      const filterOk = !packageValue || pkg === packageValue;
      const labels = card.dataset.labelsLower || "";
      const queryOk = !q || title.includes(q) || pkg.includes(q) || labels.includes(q);
      return queryOk && filterOk;
    }

    function sortCards(list, mode) {
      const copy = [...list];
      const by = {
        created_desc: (a, b) => (b.dataset.created || "").localeCompare(a.dataset.created || ""),
        created_asc: (a, b) => (a.dataset.created || "").localeCompare(b.dataset.created || ""),
        candidates_desc: (a, b) => (parseInt(b.dataset.candidates || "0", 10) - parseInt(a.dataset.candidates || "0", 10)),
        candidates_asc: (a, b) => (parseInt(a.dataset.candidates || "0", 10) - parseInt(b.dataset.candidates || "0", 10)),
        title_asc: (a, b) => (a.dataset.title || "").localeCompare(b.dataset.title || ""),
        title_desc: (a, b) => (b.dataset.title || "").localeCompare(a.dataset.title || "")
      }[mode] || ((a, b) => 0);

      copy.sort(by);
      return copy;
    }

    function render() {
      const q = (searchInput.value || "").trim().toLowerCase();
      const pkgVal = (filterSelect.value || "").trim().toLowerCase();
      const mode = sortSelect.value;

      const visible = cards.filter(c => matches(c, q, pkgVal));
      const sorted = sortCards(visible, mode);

      // Hide all, then append sorted visible in order
      cards.forEach(c => c.style.display = "none");
      sorted.forEach(c => {
        c.style.display = "";
        grid.appendChild(c);
      });
    }

    // Card click -> detail (ignore clicks on actions)
    cards.forEach(card => {
      const go = () => {
        const href = card.dataset.href;
        if (href) window.location.href = href;
      };

      card.addEventListener("click", (e) => {
        if (e.target.closest("a") || e.target.closest("button") || e.target.closest("form")) return;
        go();
      });

      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          if (e.target.closest("a") || e.target.closest("button") || e.target.closest("form")) return;
          e.preventDefault();
          go();
        }
      });
    });

    searchInput.addEventListener("input", render);
    filterSelect.addEventListener("change", render);
    sortSelect.addEventListener("change", render);

    render();
  })();
</script>
{% endblock %}