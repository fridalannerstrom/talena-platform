{% extends "customer/core/layouts/customer_base.html" %}
{% block content %}
{% load dict_extras %}
{% load static %}

<div class="container-fluid px-2 px-md-3">

  <!-- Header -->
  <div class="d-flex align-items-start justify-content-between mb-3 flex-wrap gap-2">
    <div>
      <h1 class="h4 mb-1">Testprocesser</h1>
      <div class="text-muted">Översikt över dina testprocesser och status.</div>
    </div>

    {% if not show_archived %}
      <a class="btn btn-primary" href="{% url 'processes:process_create' %}">
        Skapa testprocess
      </a>
    {% endif %}
  </div>

  <!-- Controls -->
  <div class="card mb-3">
    <div class="card-body process-list-header">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-6 col-lg-5">
          <div class="input-group">
            <span class="input-group-text bg-white">
              <i data-feather="search" style="width:16px;height:16px;"></i>
            </span>
            <input id="processSearch" type="text" class="form-control" placeholder="Sök på titel eller testpaket...">
          </div>
        </div>

        <div class="col-12 col-md-6 col-lg-4">
          <select id="packageFilter" class="form-select">
            <option value="">Alla testpaket</option>
          </select>
        </div>

        <div class="col-12 col-lg-3">
          <select id="sortBy" class="form-select">
            <option value="created_desc">Sortera: Nyast först</option>
            <option value="created_asc">Sortera: Äldst först</option>
            <option value="candidates_desc">Sortera: Flest kandidater</option>
            <option value="candidates_asc">Sortera: Färst kandidater</option>
            <option value="title_asc">Sortera: Titel A–Ö</option>
            <option value="title_desc">Sortera: Titel Ö–A</option>
          </select>
        </div>
      </div>
    </div>
  </div>
      <!-- Tabs (segmented control) -->
      <div class="mt-3 mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="seg-tabs" role="tablist" aria-label="Visa testprocesser">
          <a href="{% url 'processes:process_list' %}"
             class="seg-tab {% if not show_archived %}is-active{% endif %}"
             role="tab"
             aria-selected="{% if not show_archived %}true{% else %}false{% endif %}">
            Aktiva
          </a>

          <a href="{% url 'processes:process_list' %}?archived=1"
             class="seg-tab {% if show_archived %}is-active{% endif %}"
             role="tab"
             aria-selected="{% if show_archived %}true{% else %}false{% endif %}">
            Arkiverade
          </a>
        </div>

        {% if show_archived %}
          <div class="text-muted small">
            Här visas processer som du har arkiverat.
          </div>
        {% endif %}
      </div>
  {% if processes %}
    <div id="processGrid" class="process-grid">
      {% for p in processes %}
        <div class="process-card card"
             role="button"
             tabindex="0"
             data-href="{% url 'processes:process_detail' p.id %}"
             data-title="{{ p.name|default:''|lower }}"
             data-package="{{ p.project_name_snapshot|default:'' }}"
             data-package-lower="{{ p.project_name_snapshot|default:''|lower }}"
             data-labels-lower="{% for lab in p.labels.all %}{{ lab.name|lower }} {% endfor %}"
             data-candidates="{{ p.candidates_count|default:0 }}"
             data-created="{{ p.created_at|date:'Y-m-d' }}">

          <div class="card-body process-card-body">

            <!-- Top: labels + actions -->
            <div class="d-flex align-items-start justify-content-between gap-3">

              <!-- Labels -->
              <div class="d-flex align-items-center gap-2 flex-wrap mt-1">
                {% if p.labels.exists %}
                  {% for lab in p.labels.all %}
                    <span class="process-label">{{ lab.name }}</span>
                  {% endfor %}
                {% else %}
                  <span class="process-label process-label-muted">Ej kategoriserad</span>
                {% endif %}
              </div>

              <!-- Actions -->
{% with can_edit=can_edit_by_process_id|get_item:p.id %}
  {% if can_edit %}
    <div class="card-actions d-inline-flex gap-1 align-items-center flex-shrink-0">

      {% if not show_archived %}
        <a class="icon-btn"
           href="{% url 'processes:process_update' p.id %}"
           aria-label="Redigera"
           onclick="event.stopPropagation();">
          <i data-feather="edit"></i>
        </a>

        <form method="post"
              action="{% url 'processes:process_archive' p.id %}"
              class="d-inline"
              onsubmit="event.stopPropagation(); return confirm('Arkivera processen?');">
          {% csrf_token %}
          <button type="submit" class="icon-btn" aria-label="Arkivera">
            <i data-feather="archive"></i>
          </button>
        </form>

        <form method="post"
              action="{% url 'processes:process_delete' p.id %}"
              class="d-inline"
              onsubmit="event.stopPropagation(); return confirm('Ta bort processen? Om tester har skickats arkiveras den istället.');">
          {% csrf_token %}
          <button type="submit" class="icon-btn" aria-label="Ta bort">
            <i data-feather="trash-2"></i>
          </button>
        </form>

      {% else %}
        <form method="post"
              action="{% url 'processes:process_unarchive' p.id %}"
              class="d-inline"
              onsubmit="event.stopPropagation(); return confirm('Återställ processen till aktiva?');">
          {% csrf_token %}
          <button type="submit" class="icon-btn" aria-label="Återställ">
            <i data-feather="rotate-ccw"></i>
          </button>
        </form>
      {% endif %}

    </div>
  {% endif %}
{% endwith %}
            </div>

            <!-- Title -->
            <div class="mt-3">
              <div class="process-title mb-2">
                {{ p.name }}
              </div>

              <div class="text-muted small">
                {{ p.project_name_snapshot }}
                <br>

                {% with key=p.account_code|add:"::"|add:p.project_code %}
                  {% with m=meta_by_key|get_item:key %}
                    {% if m and m.tests %}
                      Innehåller tester:
                      {% for t in m.tests|split_tests %}
                        {{ t }}{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endwith %}
                {% endwith %}
              </div>
            </div>

            <!-- Divider -->
            <div class="card-divider"></div>

            <!-- Footer meta -->
            <div class="card-footer-meta">
              <div class="meta-item">
                <i data-feather="users" class="icon-16"></i>
                <span>Kandidater: <strong>{{ p.candidates_count|default:0 }}</strong></span>
              </div>

              <div class="meta-item">
                <i data-feather="calendar" class="icon-16"></i>
                <span>Skapad: <strong>{{ p.created_at|date:"Y-m-d" }}</strong></span>
              </div>
            </div>

          </div>
        </div>
      {% endfor %}
    </div>

  {% else %}
    <!-- Empty state (different for active vs archived) -->
    <div class="card empty-state">
      <div class="card-body p-5 text-center">

        {% if show_archived %}
          <div class="h5 mb-1">Inga arkiverade testprocesser</div>
          <div class="text-muted mb-3">När du arkiverar en process hamnar den här.</div>
        {% else %}
        <img src="{% static 'images/talena-empty-state.png' %}" alt="Talena" style="max-width: 220px;"><br><br>
          <div class="h5 mb-1">Du har inga testprocesser ännu</div>
          <div class="text-muted mb-3">Skapa en testprocess för att börja skicka tester till kandidater.</div>
          <a class="btn btn-primary" href="{% url 'processes:process_create' %}">
            Skapa din första testprocess
          </a>
        {% endif %}

      </div>
    </div>
  {% endif %}

</div>

<style>
</style>

<script>
  (function () {
    const grid = document.getElementById("processGrid");
    if (!grid) return;

    const cards = Array.from(grid.querySelectorAll(".process-card"));
    const searchInput = document.getElementById("processSearch");
    const filterSelect = document.getElementById("packageFilter");
    const sortSelect = document.getElementById("sortBy");

    // Populate filter options from existing cards (unique package names)
    const packages = new Map();
    cards.forEach(c => {
      const label = (c.dataset.package || "").trim();
      if (label) packages.set(label.toLowerCase(), label);
    });
    Array.from(packages.values())
      .sort((a, b) => a.localeCompare(b))
      .forEach(label => {
        const opt = document.createElement("option");
        opt.value = label.toLowerCase();
        opt.textContent = label;
        filterSelect.appendChild(opt);
      });

    function matches(card, q, packageValue) {
      const title = card.dataset.title || "";
      const pkg = card.dataset.packageLower || "";
      const filterOk = !packageValue || pkg === packageValue;
      const labels = card.dataset.labelsLower || "";
      const queryOk = !q || title.includes(q) || pkg.includes(q) || labels.includes(q);
      return queryOk && filterOk;
    }

    function sortCards(list, mode) {
      const copy = [...list];
      const by = {
        created_desc: (a, b) => (b.dataset.created || "").localeCompare(a.dataset.created || ""),
        created_asc: (a, b) => (a.dataset.created || "").localeCompare(b.dataset.created || ""),
        candidates_desc: (a, b) => (parseInt(b.dataset.candidates || "0", 10) - parseInt(a.dataset.candidates || "0", 10)),
        candidates_asc: (a, b) => (parseInt(a.dataset.candidates || "0", 10) - parseInt(b.dataset.candidates || "0", 10)),
        title_asc: (a, b) => (a.dataset.title || "").localeCompare(b.dataset.title || ""),
        title_desc: (a, b) => (b.dataset.title || "").localeCompare(a.dataset.title || "")
      }[mode] || ((a, b) => 0);

      copy.sort(by);
      return copy;
    }

    function render() {
      const q = (searchInput.value || "").trim().toLowerCase();
      const pkgVal = (filterSelect.value || "").trim().toLowerCase();
      const mode = sortSelect.value;

      const visible = cards.filter(c => matches(c, q, pkgVal));
      const sorted = sortCards(visible, mode);

      cards.forEach(c => c.style.display = "none");
      sorted.forEach(c => {
        c.style.display = "";
        grid.appendChild(c);
      });
    }

    // Card click -> detail (ignore clicks on actions)
    cards.forEach(card => {
      const go = () => {
        const href = card.dataset.href;
        if (href) window.location.href = href;
      };

      card.addEventListener("click", (e) => {
        if (e.target.closest("a") || e.target.closest("button") || e.target.closest("form")) return;
        go();
      });

      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          if (e.target.closest("a") || e.target.closest("button") || e.target.closest("form")) return;
          e.preventDefault();
          go();
        }
      });
    });

    searchInput.addEventListener("input", render);
    filterSelect.addEventListener("change", render);
    sortSelect.addEventListener("change", render);

    render();
  })();
</script>

{% endblock %}
