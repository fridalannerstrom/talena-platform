{% extends "customer/core/layouts/customer_base.html" %}
{% block content %}
{% load static %}

<div class="container-fluid px-2 px-md-3">

<a href="{% url 'processes:process_list' %}"
   class="text-muted small text-decoration-none">
  ← Tillbaka
</a>

<div class="card mb-3 mt-2">
  <div class="card-body">

    {# Row 1: Title + actions #}
    <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
      <div class="min-w-0">
        <div class="chip chip-labels">
          <div class="chip-value mb-3">
            {% if process.labels %}
              <div class="d-flex flex-wrap gap-2">
                {% for label in process.labels.all %}
                  <span class="process-label">{{ label }}</span>
                {% endfor %}
              </div>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        </div>

        <h2 class="mb-1 mt-2 mb-2 text-truncate">{{ process.name }}</h2>

        <div class="small text-dark">
          Skapad av:
          <span class="fw-semibold">
            {% with u=process.created_by %}
              {% if u.first_name or u.last_name %}
                {{ u.first_name }} {{ u.last_name }}
              {% else %}
                {{ u.email }}
              {% endif %}
            {% endwith %}
          </span>

          {% if process.created_at %}
            <span class="mx-1">·</span>{{ process.created_at|date:"Y-m-d H:i" }}
          {% endif %}
        </div>
      </div>

<div class="d-inline-flex align-items-center gap-2 flex-wrap justify-content-end">

  {% if can_edit %}
    <a class="btn btn-outline-secondary"
       href="{% url 'emails:edit_process_invitation_template' process.id %}">
      Mejlmallar
    </a>

    <a class="btn btn-outline-secondary"
       href="{% url 'processes:process_update' process.id %}">
      Inställningar
    </a>

    <button type="button"
            class="btn btn-outline-secondary js-selfreg">
      Självregistrering
    </button>

    <button type="button"
            class="btn btn-primary js-add-candidate"
            data-url="{% url 'processes:process_add_candidate' process.id %}">
      Lägg till kandidat
    </button>

  {% else %}
    <span class="access-pill"
          data-bs-toggle="tooltip"
          data-bs-placement="left"
          title="Du har läsbehörighet i denna testprocess. Du kan se kandidater och status, men kan inte lägga till kandidater, skicka ut test eller ändra inställningar.">
      <i data-feather="eye" class="icon-16"></i>
      Läsbehörighet
    </span>
  {% endif %}

</div>
    </div>

    {# Row 2: Key facts as chips #}
    <div class="process-header-chips mt-3">
      <div class="chip mb-3 text-dark">
        <div class="chip-label"><strong>Testmall</strong></div>
        <div class="chip-value">
          {{ process.project_name_snapshot|default:"—" }}
        </div>
      </div>

      <div class="chip text-dark">
        <div class="chip-label"><strong>Tester</strong></div>
        <div class="chip-value">
          {{ meta.tests|default:"—" }}
        </div>
      </div>
    </div>

  </div>
</div>

{# KPI grid #}
<div class="kpi-grid mb-3">
  <div class="card h-100">
    <div class="card-body">
      <div class="text-muted small">Totalt skickade tester</div>
      <div class="h3 mb-1">{{ kpis.total_sent|default:0 }}</div>
    </div>
  </div>

  <div class="card h-100">
    <div class="card-body">
      <div class="text-muted small">Påbörjade</div>
      <div class="h3 mb-1">{{ kpis.started|default:0 }}</div>
    </div>
  </div>

  <div class="card h-100">
    <div class="card-body">
      <div class="text-muted small">Slutförda</div>
      <div class="h3 mb-1">{{ kpis.completed|default:0 }}</div>
    </div>
  </div>

  <div class="card h-100">
    <div class="card-body">
      <div class="text-muted small">Ej påbörjade</div>
      <div class="h3 mb-1">{{ kpis.not_started|default:0 }}</div>
    </div>
  </div>

  <div class="card h-100">
    <div class="card-body">
      <div class="text-muted small">Utgångna</div>
      <div class="h3 mb-1">{{ kpis.expired|default:0 }}</div>
    </div>
  </div>
</div>

{# Candidates table #}
<div class="card process-sidebar">
  <div class="card-header bg-white d-flex align-items-center justify-content-between py-3">
    <div class="min-w-0">
      <div class="fw-semibold">
        Kandidater
        <div class="text-muted small">Totalt: {{ invitations|length }}</div>
      </div>
    </div>

    <button
      id="send-tests-btn"
      type="submit"
      form="send-tests-form"
      class="link-button"
      {% if not can_edit %}disabled aria-disabled="true"{% else %}disabled aria-disabled="true"{% endif %}
      data-bs-toggle="tooltip"
      title="{% if not can_edit %}Du har inte behörighet.{% else %}Markera minst en kandidat för att skicka ut test{% endif %}"
    >
      <i data-feather="send"></i> Skicka ut test
    </button>
  </div>

  <div class="card-body p-0">
    <form id="send-tests-form" method="post" action="{% url 'processes:process_send_tests' process.id %}">
      {% csrf_token %}

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 process-table">
          <thead class="table-light">
            <tr>
              <th style="width:44px;" class="ps-3">
                <input type="checkbox" id="select-all" {% if not can_edit %}disabled{% endif %}>
              </th>
              <th style="width:40%;">Kandidat</th>
              <th>Källa</th>
              <th>Status</th>
              <th style="width: 160px;">Registrerad</th>
              <th class="text-end pe-3" style="width:70px;"></th>
            </tr>
          </thead>

          <tbody>
            {% for inv in invitations %}
              <tr class="candidate-row">
                <td class="ps-3">
                  <input type="checkbox"
                         name="invitation_ids"
                         value="{{ inv.id }}"
                         class="row-check"
                         {% if not can_edit %}disabled{% endif %}>
                </td>

                <td>
                  <div class="d-flex align-items-center gap-3 process-detail-table">
                    <div class="user-initials">
                      {% with fn=inv.candidate.first_name|default:"" ln=inv.candidate.last_name|default:"" %}
                        {% if fn or ln %}
                          {{ fn|slice:":1"|upper }}{{ ln|slice:":1"|upper }}
                        {% else %}
                          ?
                        {% endif %}
                      {% endwith %}
                    </div>

                    <div class="min-w-0">
                      <div class="fw-semibold text-truncate">
                        <a href="{% url 'processes:process_candidate_detail' process.id inv.candidate.id %}"
                           class="user-link js-open-candidate"
                           data-sheet-url="{% url 'processes:process_candidate_detail' process.id inv.candidate.id %}"
                           data-candidate-name="{{ inv.candidate.first_name }} {{ inv.candidate.last_name|escape }}">
                          {{ inv.candidate.first_name }} {{ inv.candidate.last_name }}
                        </a>
                      </div>
                      <div class="text-muted small text-truncate">{{ inv.candidate.email }}</div>
                    </div>
                  </div>
                </td>

                <td class="text-muted">
                  {% if inv.source == "self_registered" %}
                    <span class="badge bg-info text-dark">Självregistrerad</span>
                  {% else %}
                    <span class="badge bg-primary">Inbjuden</span>
                  {% endif %}
                </td>

                <td>
                  <span class="badge"
                        data-invitation-id="{{ inv.id }}"
                        data-status-badge="1">
                    {{ inv.status_label }}
                  </span>
                </td>

                <td class="text-muted">
                  {{ inv.invited_at|default:inv.created_at|date:"Y-m-d" }}
                  <div class="small text-muted">{{ inv.invited_at|default:inv.created_at|date:"H:i" }}</div>
                </td>

                <td class="text-end pe-3">
                  {% if can_edit %}
                    <button type="submit"
                            class="button-icon"
                            form="send-tests-form"
                            formaction="{% url 'processes:remove_candidate_from_process' process.id inv.candidate_id %}"
                            formmethod="post"
                            onclick="return confirm('Är du säker på att du vill ta bort kandidaten?');">
                      <i data-feather="trash-2"></i>
                    </button>
                  {% else %}
                    <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" title="Du har inte behörighet.">
                      <button type="button"
                              class="button-icon"
                              disabled
                              aria-disabled="true">
                        <i data-feather="trash-2"></i>
                      </button>
                    </span>
                  {% endif %}
                </td>
              </tr>

            {% empty %}
              <tr>
                <td colspan="6" class="p-5 text-center text-muted empty-state">
                  <img src="{% static 'images/talena-empty-state.png' %}" alt="Talena"><br>

                  {% if can_edit %}
                    <div class="text-muted mb-3">Du har inga kandidater ännu.</div>

                    <div class="d-flex justify-content-center gap-2 flex-wrap">
                      <button type="button"
                              class="btn btn-primary js-add-candidate"
                              data-url="{% url 'processes:process_add_candidate' process.id %}">
                        Lägg till kandidat
                      </button>

                      <button type="button"
                              class="btn btn-primary js-selfreg">
                        Självregistreringslänk
                      </button>
                    </div>
                  {% else %}
                    <div class="text-muted mb-2">Inga kandidater ännu.</div>
                    <div class="small text-muted">
                      Du har endast läsbehörighet i denna process. Kontakta en administratör om du behöver lägga till kandidater eller skicka ut test.
                    </div>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </form>
  </div>
</div>

</div> {# /container-fluid #}

<div class="offcanvas offcanvas-bottom" tabindex="-1" id="candidateSheet">
  <div class="offcanvas-header justify-content-end">
    <span id="candidateSheetLabel" class="visually-hidden">Candidate</span>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body" id="candidateSheetBody">
    <div class="text-muted">Loading…</div>
  </div>
</div>

<!-- Add candidate modal -->
<div class="modal fade" id="addCandidateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="d-flex flex-column">
          <div class="subheading mb-1">Lägg till kandidat</div>
          <div class="text-muted small">Bjud in en kandidat till denna testprocess.</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body" id="addCandidateModalBody">
        <div class="text-muted">Loading…</div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Offcanvas */
  #candidateSheet{
    height: 97vh;
    border-top-left-radius: 18px;
    border-top-right-radius: 18px;
  }

  /* KPI grid */
  .kpi-grid{
    display:grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: 12px;
  }
  @media (max-width: 1200px){ .kpi-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
  @media (max-width: 768px){ .kpi-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

  /* Table spacing */
  .process-table tbody tr td{
    padding-top: 16px;
    padding-bottom: 16px;
  }

  .user-link{ color: inherit; text-decoration: none; }
  .user-link:hover{ text-decoration: underline; }

  .empty-state img{
    max-width: 220px;
    height: auto;
    margin-bottom: 12px;
    opacity: .95;
  }
</style>

<!-- ✅ Self registration modal (fixad: binder till alla .js-selfreg) -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll(".js-selfreg");
    if (!buttons.length) return;

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const url = "{{ self_reg_url|escapejs }}";

        openAppModal({
          title: "Självregistrering",
          bodyHtml: `
            <p class="mb-2">
              Dela länken med kandidater. Kandidater som registrerar sig via länken
              startar testet automatiskt direkt efter registrering.
            </p>

            <label class="form-label">Självregistreringslänk</label>
            <input type="text" class="form-control" value="${url}" readonly>

            <div class="d-flex align-items-center gap-3 mt-2">
              <button class="btn btn-primary" type="button"
                onclick="copyToClipboard('${url}', 'copyStatus')">
                Kopiera länk
              </button>
              <span id="copyStatus" class="small text-muted"></span>
            </div>
          `,
          footerHtml: `
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Stäng</button>
          `
        });
      });
    });
  });
</script>

<!-- Candidate sheet fetch (oförändrad) -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const sheetEl = document.getElementById("candidateSheet");
    const sheetBody = document.getElementById("candidateSheetBody");
    const sheetTitle = document.getElementById("candidateSheetLabel");
    if (!sheetEl || !sheetBody || !sheetTitle) return;

    const sheet = bootstrap.Offcanvas.getOrCreateInstance(sheetEl);

    document.querySelectorAll(".js-open-candidate").forEach(link => {
      link.addEventListener("click", async (e) => {
        e.preventDefault();

        const url = link.dataset.sheetUrl || link.getAttribute("href");
        const name = link.dataset.candidateName || "Candidate";

        sheetTitle.textContent = name;
        sheetBody.innerHTML = `<div class="text-muted">Loading…</div>`;
        sheet.show();

        try {
          const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
          if (!res.ok) {
            sheetBody.innerHTML = `<div class="alert alert-danger mb-0">Could not load candidate details (${res.status}).</div>`;
            return;
          }
          sheetBody.innerHTML = await res.text();
        } catch (err) {
          sheetBody.innerHTML = `<div class="alert alert-danger mb-0">Network error while loading candidate details.</div>`;
          console.error(err);
        }
      });
    });
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  if (!window.bootstrap) return;
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => {
    new bootstrap.Tooltip(el);
  });
  if (window.feather) feather.replace();
});
</script>

<!-- Poll statuses (din befintliga) -->
<script>
(function () {
  const url = "{% url 'processes:process_invitation_statuses' process.id %}";
  const POLL_MS = 5000;

  function badgeClassFor(status) {
    switch ((status || "").toLowerCase()) {
      case "completed": return "badge bg-success";
      case "started": return "badge bg-info text-dark";
      case "sent": return "badge bg-warning text-dark";
      case "created": return "badge bg-secondary";
      default: return "badge bg-light text-dark";
    }
  }

  async function poll() {
    try {
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      if (!res.ok) return;
      const data = await res.json();

      (data.invitations || []).forEach(inv => {
        const el = document.querySelector(`[data-status-badge="1"][data-invitation-id="${inv.id}"]`);
        if (el) {
          el.className = badgeClassFor(inv.status);

          let label = inv.status;
          const st = (inv.status || "").toLowerCase();
          if (st === "completed") label = "Färdig";
          if (st === "started") label = "Påbörjad";
          if (st === "sent") label = "Skickad";
          if (st === "created") label = "Ej skickad";

          el.textContent = label;
        }
      });
    } catch (e) {}
  }

  poll();
  setInterval(poll, POLL_MS);
})();
</script>

<!-- ✅ Send-tests knapp enable/disable (respekterar can_edit) -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const canEdit = {{ can_edit|yesno:"true,false" }};
    const btn = document.getElementById("send-tests-btn");
    const selectAll = document.getElementById("select-all");
    const checks = Array.from(document.querySelectorAll(".row-check"));

    if (!btn) return;

    function updateSendButton() {
      if (!canEdit) {
        btn.disabled = true;
        btn.setAttribute("aria-disabled", "true");
        return;
      }
      const anyChecked = checks.some(ch => ch.checked);
      btn.disabled = !anyChecked;
      btn.setAttribute("aria-disabled", String(!anyChecked));
      btn.classList.toggle("is-disabled", !anyChecked);
    }

    updateSendButton();
    checks.forEach(ch => ch.addEventListener("change", updateSendButton));

    if (selectAll) {
      selectAll.addEventListener("change", () => {
        checks.forEach(ch => ch.checked = selectAll.checked);
        updateSendButton();
      });
    }
  });
</script>

<!-- ✅ Add candidate modal (fixad: binder till alla .js-add-candidate) -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const buttons = document.querySelectorAll(".js-add-candidate");
  const modalEl = document.getElementById("addCandidateModal");
  const bodyEl = document.getElementById("addCandidateModalBody");

  if (!buttons.length || !modalEl || !bodyEl) return;
  if (!window.bootstrap) return;

  const modal = new bootstrap.Modal(modalEl);

  async function loadForm(url) {
    bodyEl.innerHTML = `<div class="text-muted">Loading…</div>`;
    modal.show();

    try {
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
      bodyEl.innerHTML = await res.text();
      if (window.feather) feather.replace();
    } catch (e) {
      bodyEl.innerHTML = `<div class="alert alert-danger mb-0">Kunde inte ladda formuläret.</div>`;
      console.error(e);
    }
  }

  buttons.forEach(btn => {
    btn.addEventListener("click", () => loadForm(btn.dataset.url));
  });

  modalEl.addEventListener("submit", async (e) => {
    const form = e.target.closest("#addCandidateForm");
    if (!form) return;

    e.preventDefault();

    try {
      const res = await fetch(form.action, {
        method: "POST",
        body: new FormData(form),
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      if (res.ok) {
        const data = await res.json();
        modal.hide();
        window.location.href = data.redirect_url || window.location.href;
        return;
      }

      bodyEl.innerHTML = await res.text();
      if (window.feather) feather.replace();
    } catch (err) {
      bodyEl.innerHTML = `<div class="alert alert-danger mb-0">Nätverksfel. Försök igen.</div>`;
      console.error(err);
    }
  });
});
</script>

{% endblock %}
