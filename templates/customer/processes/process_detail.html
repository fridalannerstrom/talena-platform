{% extends "customer/core/layouts/customer_base.html" %}
{% block content %}
<div class="container-fluid px-2 px-md-3">

  <!-- Header -->
  <div class="d-flex align-items-start justify-content-between mb-4">
    <div>
      <h1 class="h4 mb-1">{{ process.name }}</h1>
      <div class="text-muted">
        {{ process.project_name_snapshot }}
  {% if process.job_title or process.job_location %}
        · {{ process.job_title }}{% if process.job_location %} / {{ process.job_location }}{% endif %}
  {% endif %}
      </div>
    </div>

    <div class="d-inline-flex align-items-center gap-2">
      <a class="btn btn-outline-secondary"
         href="{% url 'emails:edit_process_invitation_template' process.id %}">
        Mejlmallar
      </a>

      <a class="btn btn-outline-secondary"
         href="{% url 'processes:process_update' process.id %}">
        Inställningar
      </a>

      <a class="btn btn-primary"
         href="{% url 'processes:process_add_candidate' process.id %}">
        Lägg till kandidat
      </a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mb-3">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="row g-4">

    <!-- LEFT: Process info -->
    <div class="col-12 col-lg-4 col-xl-3">
      <div class="card h-100">
        <div class="card-header bg-white py-3">
          <div class="fw-semibold">Information</div>
          <div class="text-muted small">Grunduppgifter om testprocessen</div>
        </div>

        <div class="card-body process-detail">
          <div class="mb-3">
            <div class="text-muted small mb-1">Testpaket</div>
            <div class="fw-semibold">{{ process.project_name_snapshot }}</div>
            <div class="text-muted small">Account: {{ process.account_code }} · Project: {{ process.project_code }}</div>
          </div>

          <div class="mb-3">
            <div class="text-muted small mb-1">Tester</div>
            <div>{{ meta.tests|default:"—" }}</div>
          </div>

          <div class="mb-3">
            <div class="text-muted small mb-1">Språk</div>
            <div>{{ meta.languages|default:"—" }}</div>
          </div>

          <div class="mb-4">
            <div class="text-muted small mb-1">Anteckningar</div>
            {% if process.notes %}
              <div class="text-muted">{{ process.notes }}</div>
            {% else %}
              <div class="text-muted">—</div>
            {% endif %}
          </div>

          <button type="button" class="btn btn-outline-secondary" id="btnSelfReg">
            Självregistrering
          </button>
        </div>
      </div>
    </div>

    <!-- RIGHT: Candidates -->
    <div class="col-12 col-lg-8 col-xl-9">
      <div class="card process-sidebar">
        <div class="card-header bg-white d-flex align-items-center justify-content-between py-3">
          <div>
            <div class="subheading">Kandidater</div>
            <div class="text-muted small">
              Markera kandidater och skicka ut test.
            </div>
          </div>

          <button type="submit" form="send-tests-form" class="link-button">
            <i data-feather="send"></i> Skicka ut test
          </button>
        </div>

        <div class="card-body p-0">
          <form id="send-tests-form" method="post" action="{% url 'processes:process_send_tests' process.id %}">
            {% csrf_token %}

            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width:44px;" class="ps-3">
                      <input type="checkbox" id="select-all">
                    </th>
                    <th>Kandidat</th>
                    <th>Källa</th>
                    <th>Status</th>
                    <th>Registrerad</th>
                    <th class="text-end pe-3"></th>
                  </tr>
                </thead>

                <tbody>
                  {% for inv in invitations %}
                  <tr class="candidate-row">
                    <td class="ps-3">
                      <input type="checkbox" name="invitation_ids" value="{{ inv.id }}" class="row-check">
                    </td>

                    <td>
                      <a href="{% url 'processes:process_candidate_detail' process.id inv.candidate.id %}"
                         class="text-decoration-none fw-semibold js-open-candidate"
                         data-sheet-url="{% url 'processes:process_candidate_detail' process.id inv.candidate.id %}"
                         data-candidate-name="{{ inv.candidate.first_name }} {{ inv.candidate.last_name|escape }}">
                        {{ inv.candidate.first_name }} {{ inv.candidate.last_name }}
                      </a>
                      <div class="small text-muted">{{ inv.candidate.email }}</div>
                    </td>

                    <td>
                      {% if inv.source == "self_registered" %}
                        <span class="badge bg-info text-dark">Självregistrerad</span>
                      {% else %}
                        <span class="badge bg-primary">Inbjuden</span>
                      {% endif %}
                    </td>

                    <td>
                      <!-- Talena status -->
                      <span class="badge"
                            data-invitation-id="{{ inv.id }}"
                            data-status-badge="1">
                        {{ inv.status_label }}
                      </span>

                      <!-- SOVA overall status (EN badge, inte dubbelt) -->
                      <span class="badge bg-light text-dark ms-1"
                            data-sova-badge="1"
                            data-invitation-id="{{ inv.id }}">
                        SOVA: {{ inv.sova_overall_status|default:"—" }}
                      </span>
                    </td>

                    <td class="text-muted">
                      {{ inv.invited_at|default:inv.created_at|date:"Y-m-d" }}
                      <div class="small text-muted">{{ inv.invited_at|default:inv.created_at|date:"H:i" }}</div>
                    </td>

                    <td class="text-end pe-3">
                      <button type="submit"
                              class="button-icon"
                              form="send-tests-form"
                              formaction="{% url 'processes:remove_candidate_from_process' process.id inv.candidate_id %}"
                              formmethod="post"
                              onclick="return confirm('Är du säker på att du vill ta bort kandidaten?');">
                        <i data-feather="trash-2"></i>
                      </button>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="6" class="p-5 text-center text-muted">
                      Inga kandidater ännu. Klicka på <strong>Lägg till kandidat</strong> för att komma igång.
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </form>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Candidate Slide-up (Bottom Sheet) -->
<div class="offcanvas offcanvas-bottom" tabindex="-1" id="candidateSheet" aria-labelledby="Candidate details">
  <div class="offcanvas-header justify-content-end">
    <span id="candidateSheetLabel" class="visually-hidden">Candidate</span>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body" id="candidateSheetBody">
    <div class="text-muted">Loading…</div>
  </div>
</div>

<style>
  /* matchar din process_list-känsla */
  #candidateSheet {
    height: 97vh;
    border-top-left-radius: 18px;
    border-top-right-radius: 18px;
  }

  /* lite luftigare rader, samma som listan */
  .table tbody tr td {
    padding-top: 16px;
    padding-bottom: 16px;
  }
</style>

<script>
  // Checkbox "select all"
  const selectAll = document.getElementById("select-all");
  const checks = document.querySelectorAll(".row-check");
  if (selectAll) {
    selectAll.addEventListener("change", () => {
      checks.forEach(ch => ch.checked = selectAll.checked);
    });
  }
</script>

<!-- Self registration modal (din befintliga) -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnSelfReg");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const url = "{{ self_reg_url|escapejs }}";

      openAppModal({
        title: "Självregistrering",
        bodyHtml: `
          <p class="mb-2">
            Dela länken med kandidater. Kandidater som registrerar sig via länken
            startar testet automatiskt direkt efter registrering.
          </p>

          <label class="form-label">Self-registration URL</label>
          <input type="text" class="form-control" value="${url}" readonly>

          <div class="d-flex align-items-center gap-3 mt-2">
            <button class="btn btn-primary" type="button"
              onclick="copyToClipboard('${url}', 'copyStatus')">
              Copy link
            </button>
            <span id="copyStatus" class="small text-muted"></span>
          </div>
        `,
        footerHtml: `
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
        `
      });
    });
  });
</script>

<!-- Candidate sheet fetch (din befintliga, oförändrad) -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const sheetEl = document.getElementById("candidateSheet");
    const sheetBody = document.getElementById("candidateSheetBody");
    const sheetTitle = document.getElementById("candidateSheetLabel");
    if (!sheetEl || !sheetBody || !sheetTitle) return;

    const sheet = bootstrap.Offcanvas.getOrCreateInstance(sheetEl);

    document.querySelectorAll(".js-open-candidate").forEach(link => {
      link.addEventListener("click", async (e) => {
        e.preventDefault();

        const url = link.dataset.sheetUrl || link.getAttribute("href");
        const name = link.dataset.candidateName || "Candidate";

        sheetTitle.textContent = name;
        sheetBody.innerHTML = `<div class="text-muted">Loading…</div>`;
        sheet.show();

        try {
          const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
          if (!res.ok) {
            sheetBody.innerHTML = `<div class="alert alert-danger mb-0">Could not load candidate details (${res.status}).</div>`;
            return;
          }
          sheetBody.innerHTML = await res.text();
        } catch (err) {
          sheetBody.innerHTML = `<div class="alert alert-danger mb-0">Network error while loading candidate details.</div>`;
          console.error(err);
        }
      });
    });
  });
</script>

<!-- Poll statuses (din befintliga, men städad från dubletter) -->
<script>
(function () {
  const url = "{% url 'processes:process_invitation_statuses' process.id %}";
  const POLL_MS = 5000;

  function badgeClassFor(status) {
    switch ((status || "").toLowerCase()) {
      case "completed": return "badge bg-success";
      case "started": return "badge bg-info text-dark";
      case "sent": return "badge bg-warning text-dark";
      case "created": return "badge bg-secondary";
      default: return "badge bg-light text-dark";
    }
  }

  async function poll() {
    try {
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      if (!res.ok) return;
      const data = await res.json();

      (data.invitations || []).forEach(inv => {
        const el = document.querySelector(`[data-status-badge="1"][data-invitation-id="${inv.id}"]`);
        if (el) {
          el.className = badgeClassFor(inv.status);

          let label = inv.status;
          const st = (inv.status || "").toLowerCase();
          if (st === "completed") label = "Färdig";
          if (st === "started") label = "Påbörjad";
          if (st === "sent") label = "Skickad";
          if (st === "created") label = "Ej skickad";

          el.textContent = label;
        }

        const sovaEl = document.querySelector(`[data-sova-badge="1"][data-invitation-id="${inv.id}"]`);
        if (sovaEl) {
          const sovaVal = (inv.sova_overall_status || "—");
          sovaEl.textContent = `SOVA: ${sovaVal}`;
        }
      });
    } catch (e) {}
  }

  poll();
  setInterval(poll, POLL_MS);
})();
</script>

{% endblock %}
