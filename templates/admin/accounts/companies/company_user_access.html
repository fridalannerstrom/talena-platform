{% extends "admin/core/layouts/admin_base.html" %}
{% block title %}{{ company.name }} | Talena{% endblock %}

{% block content %}
{% load org_extras %}
<div class="container-fluid px-2 px-md-4">
{% include "admin/accounts/companies/_company_header.html" with company=company active="access" show_invite_button=True %}

  <div class="row g-3">
    <!-- LEFT: users list -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-semibold"><i class="fa-solid fa-users me-2"></i> Users</div>
          <span class="badge bg-light text-dark">{{ users|length }}</span>
        </div>
        <div class="list-group list-group-flush">
          {% for u in users %}
            <a class="list-group-item list-group-item-action {% if selected_user and u.pk == selected_user.pk %}active{% endif %}"
               href="{% url 'accounts:company_user_access' company.pk %}?user={{ u.pk }}">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ u.get_full_name|default:u.email }}</div>
                  <div class="small {% if selected_user and u.pk == selected_user.pk %}text-white-50{% else %}text-muted{% endif %}">
                    {{ u.email }}
                  </div>
                </div>
                {% if u.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% endif %}
              </div>
            </a>
          {% empty %}
            <div class="p-3 text-muted">No users yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- RIGHT: access checklist -->
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-semibold"><i class="fa-solid fa-user-shield me-2"></i> Account access</div>
          {% if selected_user %}
            <span class="badge bg-label-primary">{{ selected_user.email }}</span>
          {% else %}
            <span class="badge bg-label-secondary">V√§lj en user</span>
          {% endif %}
        </div>

        <div class="card-body">
          {% if not selected_user %}
            <div class="text-muted">V√§lj en anv√§ndare till v√§nster f√∂r att hantera access.</div>
          {% else %}

           <div class="text-muted small mb-3">
  Klicka i/ur accounts, sen klicka <strong>Spara</strong> n√§r du √§r klar.
</div>

<div class="d-flex flex-wrap gap-2 mb-3">
  <button type="button" class="btn btn-sm btn-outline-secondary" id="btnSelectAll">
    Markera alla
  </button>
  <button type="button" class="btn btn-sm btn-outline-secondary" id="btnDeselectAll">
    Avmarkera alla
  </button>

</div>

<div id="accessTree">
  <ul class="list-unstyled m-0">
    {% for unit in root_units %}
      {% include "admin/accounts/companies/_orgunit_access_node.html" with unit=unit children_map=children_map checked_ids=checked_ids %}
    {% empty %}
      <li class="text-muted">Inga accounts √§nnu. Skapa struktur f√∂rst.</li>
    {% endfor %}
  </ul>
</div>

<div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
      <span class="ms-auto small text-muted align-self-center" id="dirtyHint" style="display:none;">
    Du har osparade √§ndringar
  </span>
  <button type="button" class="btn btn-outline-secondary" id="btnReset">
    √Öterst√§ll
  </button>
  <button type="button" class="btn btn-primary" id="btnSave" disabled>
    Spara √§ndringar
  </button>
</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

{% if selected_user %}
<script>
(function () {
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }
  const csrftoken = getCookie("csrftoken");
  const selectedUserId = {{ selected_user.pk }};

  const tree = document.getElementById("accessTree");
  const btnSave = document.getElementById("btnSave");
  const btnReset = document.getElementById("btnReset");
  const btnSelectAll = document.getElementById("btnSelectAll");
  const btnDeselectAll = document.getElementById("btnDeselectAll");
  const dirtyHint = document.getElementById("dirtyHint");

  const checkboxes = () => Array.from(tree.querySelectorAll("[data-unit-checkbox]"));

  function toast(msg, type="warning") {
    const el = document.createElement("div");
    el.className = "alert alert-" + type + " position-fixed";
    el.style.right = "16px";
    el.style.bottom = "16px";
    el.style.zIndex = "9999";
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2200);
  }

  // --- State: original selection (for reset + dirty) ---
  const original = new Set(
    checkboxes().filter(cb => cb.checked).map(cb => parseInt(cb.dataset.unitId, 10))
  );

  function currentSelectionSet() {
    return new Set(
      checkboxes().filter(cb => cb.checked).map(cb => parseInt(cb.dataset.unitId, 10))
    );
  }

  function setsEqual(a, b) {
    if (a.size !== b.size) return false;
    for (const v of a) if (!b.has(v)) return false;
    return true;
  }

  function updateDirtyUI() {
    const cur = currentSelectionSet();
    const isDirty = !setsEqual(original, cur);

    btnSave.disabled = !isDirty;
    if (dirtyHint) dirtyHint.style.display = isDirty ? "inline" : "none";
  }

  // Mark dirty when user changes anything
  tree.addEventListener("change", (e) => {
    if (!e.target.matches("[data-unit-checkbox]")) return;
    updateDirtyUI();
  });

  // Select all / deselect all
  btnSelectAll?.addEventListener("click", () => {
    checkboxes().forEach(cb => { cb.checked = true; });
    updateDirtyUI();
  });

  btnDeselectAll?.addEventListener("click", () => {
    checkboxes().forEach(cb => { cb.checked = false; });
    updateDirtyUI();
  });

  // Reset to original
  btnReset?.addEventListener("click", () => {
    const orig = new Set(original);
    checkboxes().forEach(cb => {
      const id = parseInt(cb.dataset.unitId, 10);
      cb.checked = orig.has(id);
    });
    updateDirtyUI();
    toast("√Öterst√§llt", "secondary");
  });

  async function saveAll() {
    const unitIds = Array.from(currentSelectionSet());

    const resp = await fetch("{% url 'accounts:company_user_access_set' company.pk %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({
        user_id: selectedUserId,
        unit_ids: unitIds,
        mode: "replace"   // üëà vi ers√§tter hela access-listan
      })
    });

    const data = await resp.json();
    if (!resp.ok || !data.ok) throw new Error(data.error || "Save failed");
    return data;
  }

  btnSave?.addEventListener("click", async () => {
    btnSave.disabled = true;

    // disable all controls during save
    checkboxes().forEach(cb => cb.disabled = true);
    btnSelectAll.disabled = true;
    btnDeselectAll.disabled = true;
    btnReset.disabled = true;

    try {
      await saveAll();

      // update original set => now clean
      original.clear();
      currentSelectionSet().forEach(id => original.add(id));

      updateDirtyUI();
      toast("Sparat!", "success");
    } catch (err) {
      console.error(err);
      toast("Kunde inte spara √§ndringen");
      updateDirtyUI(); // re-enable save if still dirty
    } finally {
      checkboxes().forEach(cb => cb.disabled = false);
      btnSelectAll.disabled = false;
      btnDeselectAll.disabled = false;
      btnReset.disabled = false;
    }
  });

  // initial state
  updateDirtyUI();
})();
</script>
{% endif %}

{% endblock %}
