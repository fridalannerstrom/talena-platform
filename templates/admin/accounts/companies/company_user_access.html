{% extends "admin/accounts/companies/company_base.html" %}
{% block title %}Companies | Talena{% endblock %}

{% load accounts_extras %}


{% block company_content %}
{% load org_extras %}


<div class="card border-0">

  <div class="row g-3">
    <!-- LEFT: users list -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-semibold"><i class="fa-solid fa-users me-2"></i> Users!!</div>
          <span class="badge bg-light text-dark">{{ users|length }}</span>
        </div>
        <div class="list-group list-group-flush">
          {% for u in users %}
            <a class="list-group-item list-group-item-action {% if selected_user and u.pk == selected_user.pk %}active{% endif %}"
               href="{% url 'accounts:company_user_access' company.pk %}?user={{ u.pk }}">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ u.get_full_name|default:u.email }}</div>
                  <div class="small {% if selected_user and u.pk == selected_user.pk %}text-white-50{% else %}text-muted{% endif %}">
                    {{ u.email }}
                  </div>
                </div>
                {% if u.is_active %}
                  <span class="badge bg-success">Aktiv</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Inbjudan skickad</span>
                {% endif %}
              </div>
            </a>
          {% empty %}
            <div class="p-3 text-muted">No users yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>

<!-- RIGHT: access checklist -->
<div class="col-lg-8">
  <div class="card h-100">

    <!-- Header -->
    <div class="card-header  d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
        <div class="min-w-0">
          <div class="fw-semibold d-flex align-items-center gap-2">
            <i class="fa-solid fa-user-shield text-primary"></i>
            <span>Account access</span>
          </div>
          <div class="text-muted small mt-1">
            Hantera enheter och behörighet för vald användare.
          </div>
        </div>

        <div class="d-flex align-items-center gap-2 ms-auto">
          {% if selected_user %}
            <span class="badge bg-label-primary text-truncate" style="max-width: 260px;">
              {{ selected_user.email }}
            </span>
          {% else %}
            <span class="badge bg-label-secondary">Välj en användare</span>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="card-body">

      {% if not selected_user %}
        <div class="border rounded-3 p-4 text-center bg-light">
          <div class="mb-2">
            <i class="fa-solid fa-circle-info text-muted"></i>
          </div>
          <div class="fw-semibold">Ingen användare vald</div>
          <div class="text-muted small mt-1">
            Välj en användare till vänster för att hantera access.
          </div>
        </div>

      {% else %}

        <!-- Primary unit (top section) -->
        <div class="border rounded-3 p-3 p-md-4 mb-3">
          <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
            <div class="min-w-0">
              <div class="fw-semibold">Primär enhet</div>
              <div class="text-muted small">
                Testprocesser som användaren själv skapar hamnar automatiskt i denna enhet.
              </div>
            </div>
          </div>

          <div class="mt-3">
            <select
              class="form-select"
              id="primaryOrgUnitSelect"
              data-company-id="{{ company.id }}"
              data-user-id="{{ selected_user.id }}"
            >
              <option value="">Välj primär enhet…</option>
              {% for u in all_units %}
                <option value="{{ u.id }}" {% if u.id == selected_primary_id %}selected{% endif %}>
                  {{ u.full_path }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Instructions + quick actions -->
        <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mb-3">
          <div class="text-muted small">
            Klicka i/ur enheter, sen klicka <strong>Spara ändringar</strong> när du är klar.
          </div>

          <div role="group" aria-label="Bulk actions">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnSelectAll">
              <i class="fa-solid fa-check-double me-1"></i> Markera alla
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnDeselectAll">
              <i class="fa-solid fa-xmark me-1"></i> Avmarkera alla
            </button>
          </div>
        </div>


        <!-- Tree container -->
        <div class="border rounded-3">
          <div class="px-3 py-3 border-bottom d-flex align-items-center justify-content-between">
            <div class="fw-semibold">Enhetsstruktur</div>
            <div class="text-muted small">Välj behörighet</div>
          </div>

          <div class="p-2 p-md-3" style="max-height: 520px; overflow:auto;">
            <div id="accessTree">
              <ul class="list-unstyled m-0">
                {% for unit in root_units %}
                  {% include "admin/accounts/companies/_orgunit_access_node.html" with unit=unit company=company children_map=children_map checked_ids=checked_ids %}
                {% empty %}
                  <li class="text-muted px-2 py-3">
                    Inga accounts ännu. Skapa struktur först.
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>

      {% endif %}
    </div>

    <!-- Footer actions -->

    

    {% if selected_user %}
      <div class="card-footer bg-transparent d-flex align-items-center justify-content-end gap-2">
                  <span class="ms-auto small text-muted" id="dirtyHint" style="display:none;">
            <i class="fa-solid fa-pen-to-square me-1"></i> Du har osparade ändringar
          </span>
        <button type="button" class="btn btn-outline-secondary" id="btnReset">
          <i class="fa-solid fa-arrow-rotate-left me-1"></i> Återställ
        </button>
        <button type="button" class="btn btn-primary" id="btnSave" disabled>
          <i class="fa-solid fa-floppy-disk me-1"></i> Spara ändringar
        </button>
      </div>
    {% endif %}

  </div>
</div>

  </div>

</div>

{% if selected_user %}


<script>
document.addEventListener("change", function (e) {
  const checkbox = e.target.closest("[data-unit-checkbox]");
  if (!checkbox) return;

  const li = checkbox.closest("li");
  if (!li) return;

  const isChecked = checkbox.checked;

  // Hitta alla child-checkboxar inom denna gren
  const childCheckboxes = li.querySelectorAll(
    "ul input[data-unit-checkbox]"
  );

  childCheckboxes.forEach(cb => {
    cb.checked = isChecked;
  });
});
</script>

<script>
(function () {
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }

  const csrftoken = getCookie("csrftoken");
  const selectedUserId = {{ selected_user.pk }};

  const tree = document.getElementById("accessTree");
  const btnSave = document.getElementById("btnSave");
  const btnReset = document.getElementById("btnReset");
  const btnSelectAll = document.getElementById("btnSelectAll");
  const btnDeselectAll = document.getElementById("btnDeselectAll");
  const dirtyHint = document.getElementById("dirtyHint");
  const primarySelect = document.getElementById("primaryOrgUnitSelect");

  if (!tree) return;

  const checkboxes = () => Array.from(tree.querySelectorAll("[data-unit-checkbox]"));

  function getPermissionForUnit(unitId) {
    const checked = tree.querySelector(
      `input[data-perm-radio][data-unit-id="${unitId}"]:checked`
    );
    return checked ? checked.value : "viewer";
  }

  function toast(msg, type="warning") {
    const el = document.createElement("div");
    el.className = "alert alert-" + type + " position-fixed";
    el.style.right = "16px";
    el.style.bottom = "16px";
    el.style.zIndex = "9999";
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2200);
  }

  // --- State: originals (for reset + dirty) ---
  const originalUnits = new Set(
    checkboxes().filter(cb => cb.checked).map(cb => parseInt(cb.dataset.unitId, 10))
  );
  const originalPrimary = primarySelect ? (primarySelect.value || "") : "";

  // NEW: original perms for currently checked units (enough för MVP)
  const originalPerms = {};
  originalUnits.forEach(id => {
    originalPerms[id] = getPermissionForUnit(id);
  });

  function currentSelectionSet() {
    return new Set(
      checkboxes().filter(cb => cb.checked).map(cb => parseInt(cb.dataset.unitId, 10))
    );
  }

  function setsEqual(a, b) {
    if (a.size !== b.size) return false;
    for (const v of a) if (!b.has(v)) return false;
    return true;
  }

  function permsEqual(origPerms, currentUnitIds) {
    for (const id of currentUnitIds) {
      const cur = getPermissionForUnit(id);
      const orig = origPerms[id] ?? "viewer";
      if (cur !== orig) return false;
    }
    // Om man avmarkerar en unit: ignore perms för den (den sparas ändå inte)
    return true;
  }

  function updateDirtyUI() {
    const curUnits = currentSelectionSet();

    const isDirtyUnits = !setsEqual(originalUnits, curUnits);
    const isDirtyPrimary = primarySelect ? (primarySelect.value || "") !== originalPrimary : false;
    const isDirtyPerms = !permsEqual(originalPerms, curUnits);

    const isDirty = isDirtyUnits || isDirtyPrimary || isDirtyPerms;

    btnSave.disabled = !isDirty;
    if (dirtyHint) dirtyHint.style.display = isDirty ? "inline" : "none";
  }

  // Mark dirty when user changes anything (checkbox OR radio)
  tree.addEventListener("change", (e) => {
    if (
      e.target.matches("[data-unit-checkbox]") ||
      e.target.matches("[data-perm-radio]")
    ) {
      updateDirtyUI();
    }
  });

  primarySelect?.addEventListener("change", updateDirtyUI);

  btnSelectAll?.addEventListener("click", () => {
    checkboxes().forEach(cb => { cb.checked = true; });
    updateDirtyUI();
  });

  btnDeselectAll?.addEventListener("click", () => {
    checkboxes().forEach(cb => { cb.checked = false; });
    updateDirtyUI();
  });

  btnReset?.addEventListener("click", () => {
    const orig = new Set(originalUnits);
    checkboxes().forEach(cb => {
      const id = parseInt(cb.dataset.unitId, 10);
      cb.checked = orig.has(id);

      // reset perm UI för de som är checked
      if (orig.has(id)) {
        const wanted = originalPerms[id] || "viewer";
        const radio = tree.querySelector(`input[data-perm-radio][data-unit-id="${id}"][value="${wanted}"]`);
        if (radio) radio.checked = true;
      }
    });

    if (primarySelect) primarySelect.value = originalPrimary;

    updateDirtyUI();
    toast("Återställt", "secondary");
  });

  async function saveAll() {
    const unitIds = Array.from(currentSelectionSet());

    const access = unitIds.map(id => ({
      org_unit_id: id,
      permission: getPermissionForUnit(id),
    }));

    const primaryOrgUnitId = primarySelect ? (primarySelect.value || null) : null;

    const resp = await fetch("{% url 'accounts:company_user_access_set' company.pk %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({
        user_id: selectedUserId,
        mode: "replace",
        primary_org_unit_id: primaryOrgUnitId,
        access: access,
      }),
    });

    const data = await resp.json();
    if (!resp.ok || !data.ok) throw new Error(data.error || "Save failed");
    return data;
  }

  btnSave?.addEventListener("click", async () => {
    btnSave.disabled = true;

    checkboxes().forEach(cb => cb.disabled = true);
    btnSelectAll.disabled = true;
    btnDeselectAll.disabled = true;
    btnReset.disabled = true;
    if (primarySelect) primarySelect.disabled = true;

    try {
      await saveAll();
      toast("Sparat!", "success");
      window.location.reload();
    } catch (err) {
      console.error(err);
      toast("Kunde inte spara ändringen");
      updateDirtyUI();
    } finally {
      checkboxes().forEach(cb => cb.disabled = false);
      btnSelectAll.disabled = false;
      btnDeselectAll.disabled = false;
      btnReset.disabled = false;
      if (primarySelect) primarySelect.disabled = false;
    }
  });

  updateDirtyUI();
})();
</script>


{% endif %}

{% endblock %}
