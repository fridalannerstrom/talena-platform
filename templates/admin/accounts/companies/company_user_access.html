{% extends "admin/core/layouts/admin_base.html" %}
{% load org_extras %}
{% block title %}User access | {{ company.name }}{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-4">

  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <a href="{% url 'accounts:company_list' %}" class="text-muted small d-inline-flex align-items-center mb-2">
        <i class="fa-solid fa-arrow-left me-2"></i> Tillbaka
      </a>
      <h1 class="h4 mb-1">{{ company.name }}</h1>
      <div class="text-muted small">Här hanterar du endast användares access till accounts/sub-accounts.</div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary" href="{% url 'accounts:company_account_structure' company.pk %}">
        <i class="fa-solid fa-sitemap me-2"></i> Manage account structure
      </a>
    </div>
  </div>

  <div class="row g-3">
    <!-- LEFT: users list -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-semibold"><i class="fa-solid fa-users me-2"></i> Users</div>
          <span class="badge bg-light text-dark">{{ users|length }}</span>
        </div>
        <div class="list-group list-group-flush">
          {% for u in users %}
            <a class="list-group-item list-group-item-action {% if selected_user and u.pk == selected_user.pk %}active{% endif %}"
               href="{% url 'accounts:company_user_access' company.pk %}?user={{ u.pk }}">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ u.get_full_name|default:u.email }}</div>
                  <div class="small {% if selected_user and u.pk == selected_user.pk %}text-white-50{% else %}text-muted{% endif %}">
                    {{ u.email }}
                  </div>
                </div>
                {% if u.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% endif %}
              </div>
            </a>
          {% empty %}
            <div class="p-3 text-muted">No users yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- RIGHT: access checklist -->
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-semibold"><i class="fa-solid fa-user-shield me-2"></i> Account access</div>
          {% if selected_user %}
            <span class="badge bg-label-primary">{{ selected_user.email }}</span>
          {% else %}
            <span class="badge bg-label-secondary">Välj en user</span>
          {% endif %}
        </div>

        <div class="card-body">
          {% if not selected_user %}
            <div class="text-muted">Välj en användare till vänster för att hantera access.</div>
          {% else %}
            <div class="text-muted small mb-3">
              Klicka i/ur accounts. Ändringar sparas direkt.
            </div>

            <ul class="list-unstyled m-0">
              {% for unit in root_units %}
                {% include "admin/accounts/companies/_orgunit_access_node.html" with unit=unit children_map=children_map checked_ids=checked_ids %}
              {% empty %}
                <li class="text-muted">Inga accounts ännu. Skapa struktur först.</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

{% if selected_user %}
<script>
(function () {
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }
  const csrftoken = getCookie("csrftoken");
  const selectedUserId = {{ selected_user.pk }};

  function toast(msg, type="warning") {
    const el = document.createElement("div");
    el.className = "alert alert-" + type + " position-fixed";
    el.style.right = "16px";
    el.style.bottom = "16px";
    el.style.zIndex = "9999";
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2000);
  }

  async function save(unitId, grant) {
    const resp = await fetch("{% url 'accounts:company_user_access_set' company.pk %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({
        user_id: selectedUserId,
        unit_ids: [unitId],
        grant: grant
      })
    });
    const data = await resp.json();
    if (!resp.ok || !data.ok) throw new Error(data.error || "Save failed");
    return data;
  }

  document.querySelectorAll("[data-unit-checkbox]").forEach(cb => {
    cb.addEventListener("change", async (e) => {
      const unitId = parseInt(cb.dataset.unitId, 10);
      const grant = cb.checked;

      cb.disabled = true;
      try {
        await save(unitId, grant);
        toast(grant ? "Access granted" : "Access removed", "success");
      } catch (err) {
        console.error(err);
        cb.checked = !grant; // revert
        toast("Kunde inte spara ändringen");
      } finally {
        cb.disabled = false;
      }
    });
  });
})();
</script>
{% endif %}
{% endblock %}
