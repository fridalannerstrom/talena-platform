  {% with indent=level|add:0 %}
<li class="list-group-item border-0 border-bottom py-2">

  <div class="d-flex align-items-center gap-2">

    <!-- LEFT (indent only here) -->
    <div class="d-flex align-items-center gap-2 min-w-0 flex-grow-1"
         style="padding-left: calc({{ indent }} * 1.35rem);">

      <!-- Tree line + dot -->
      {% if level > 0 %}
        <span class="position-relative me-1" style="width: 18px; height: 18px;">
          <span class="position-absolute top-0 bottom-0 start-50 translate-middle-x"
                style="width:1px; background: rgba(67,89,113,.18);"></span>
          <span class="position-absolute top-50 start-50 translate-middle"
                style="width:8px; height:8px; border-radius:50%;
                       background: rgba(105,108,255,.15);
                       border:1px solid rgba(105,108,255,.30);"></span>
        </span>
      {% else %}
        <span style="width: 18px;"></span>
      {% endif %}

      <!-- Caret -->
      {% if account.children.exists %}
        <a class="text-muted d-inline-flex align-items-center"
           data-bs-toggle="collapse"
           href="#acc-{{ account.id }}"
           role="button"
           aria-expanded="false"
           aria-controls="acc-{{ account.id }}"
           title="Expandera/komprimera">
          <i class="fa-solid fa-chevron-right tree-caret"></i>
        </a>
      {% else %}
        <span style="width: 16px;"></span>
      {% endif %}

      <!-- Icon -->
      <span class="avatar avatar-xs rounded bg-label-secondary">
        {% if account.children.exists %}
          <i class="fa-regular fa-folder"></i>
        {% else %}
          <i class="fa-regular fa-file-lines"></i>
        {% endif %}
      </span>

      <!-- Text -->
      <div class="min-w-0">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="fw-semibold text-truncate" style="max-width: 520px;">
            {{ account.name }}
          </span>
          <span class="badge bg-label-secondary">{{ account.account_code }}</span>

          {% if account.children.exists %}
            <span class="badge bg-label-success">
              {{ account.children.count }} underkonto{{ account.children.count|pluralize:"n" }}
            </span>
          {% endif %}
        </div>

        {% if account.parent %}
          <div class="text-muted small text-truncate" style="max-width: 720px;">
            {{ account.full_path }}
          </div>
        {% endif %}
      </div>
    </div>

    <!-- RIGHT (fixed column, never indented) -->
    <div class="d-flex align-items-center gap-1 flex-shrink-0 ms-auto"
         style="min-width: 190px; justify-content: flex-end;">
      <a href="{% url 'accounts:company_account_users' company.pk account.pk %}"
         class="btn btn-icon btn-sm btn-outline-success"
         data-bs-toggle="tooltip" title="Användare">
        <i class="fa-solid fa-users"></i>
      </a>

      <a href="{% url 'accounts:company_account_create_child' company.pk account.pk %}"
         class="btn btn-icon btn-sm btn-primary"
         data-bs-toggle="tooltip" title="Lägg till underkonto">
        <i class="fa-solid fa-plus"></i>
      </a>

      <a href="{% url 'accounts:company_account_edit' company.pk account.pk %}"
         class="btn btn-icon btn-sm btn-outline-warning"
         data-bs-toggle="tooltip" title="Redigera">
        <i class="fa-solid fa-pen"></i>
      </a>

      <a href="{% url 'accounts:company_account_delete' company.pk account.pk %}"
         class="btn btn-icon btn-sm btn-outline-danger"
         data-bs-toggle="tooltip" title="Radera"
         onclick="return confirm('Vill du verkligen radera detta konto och alla underkonton?')">
        <i class="fa-solid fa-trash"></i>
      </a>
    </div>

  </div>

  <!-- Children -->
  {% if account.children.exists %}
    <div class="collapse account-tree-collapse mt-2" id="acc-{{ account.id }}">
      <ul class="list-group list-group-flush ms-2">
        {% for child in account.children.all %}
          {% include "admin/accounts/hierarchy/_account_tree.html" with account=child level=level|add:1 %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

</li>
{% endwith %}
